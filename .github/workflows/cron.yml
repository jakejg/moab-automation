name: moonflower-lunch

on:
  schedule:
    - cron: '50 17 * * *'  # Triggers at 17:50 UTC (11:50 AM MDT)
    - cron: '50 18 * * *'  # Triggers at 18:50 UTC (11:50 AM MST)
  workflow_dispatch:      # Allows manual triggering for testing

jobs:
  # JOB 1: THE GATEKEEPER
  # This job runs first and decides if the main job should proceed.
  time-check-gate:
    runs-on: ubuntu-latest
    # This 'outputs' section makes the result of this job available to other jobs.
    outputs:
      proceed: ${{ steps.time-check.outputs.proceed }}
    steps:
      - name: Check if it is the correct time to run
        id: time-check
        run: |
          TARGET_HOUR=$(TZ='America/Denver' date +'%H')
          TARGET_MINUTE=$(TZ='America/Denver' date +'%M')
          # Allow runs between 11:50 AM and 12:15 PM to handle GitHub Actions delays
          if [[ "$TARGET_HOUR" == "11" && 10#$TARGET_MINUTE -ge 50 ]] || [[ "$TARGET_HOUR" == "12" && 10#$TARGET_MINUTE -le 15 ]]; then
            echo "✅ SUCCESS: Within time window (11:50-12:15 Denver). The main job will run."
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "❌ SKIPPED: Outside time window. Current time: $TARGET_HOUR:$TARGET_MINUTE Denver. The main job will be skipped."
            echo "proceed=false" >> $GITHUB_OUTPUT
          fi

  # JOB 2: THE MAIN JOB
  # This job contains all your actual logic and only runs if the gatekeeper job succeeds.
  run-cron:
    # 'needs' ensures that this job waits for 'time-check-gate' to finish.
    needs: time-check-gate
    # This is the single 'if' condition that controls the entire job!
    if: needs.time-check-gate.outputs.proceed == 'true'
    
    runs-on: ubuntu-latest
    env:
      LUNCH_PAGE_URL: ${{ vars.LUNCH_PAGE_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm install

      - name: Compile TypeScript
        run: npx tsc

      - name: Run cron script
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_PHONE_NUMBER: ${{ secrets.TWILIO_PHONE_NUMBER }}
        run: node dist/cron.js